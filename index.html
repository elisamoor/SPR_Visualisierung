<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SPR Visualisierung</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script type="module">
      // fetching the csv file and making it accessible as an array of objects
      const data = await d3.csv("DHdataVis.csv");
      console.log("hello world");
      console.log(data);
      let filteredData = [data, data];
      let filters = [{}, {}];

      /**
       * Function to restrict the data based on the selected values.
       * @param {Event} e Input event. we currently only use the value of the Select element.
       * @param {string} key The key of the filter object. may be any key of the data object.
       * @param {number} dataIndex The index of the data array to filter.
       */
      function restrictData(value, key, dataIndex) {
        if (value) {
          filters[dataIndex][key] = value;
        } else {
          delete filters[dataIndex][key];
        }
        filteredData[dataIndex] = data.filter((d) =>
          Object.entries(filters[dataIndex]).every(
            ([key, value]) => d[key] === value
          )
        );
        document.querySelector(
          `.chart#section${dataIndex + 1} .dataset-size`
        ).textContent = `Es wurden ${filteredData[dataIndex].length} Datens채tze selektiert`;
        console.log(filteredData[dataIndex]);
      }

      function generateVis(index) {
        console.log("generating vis for section", index + 1);
        //these are your data: filteredData[index]
      }
      // creating the select elements for the filters
      // sentence
      const sentenceRange = new Set(data.map((d) => d.sentence));
      const sentenceSelects = document.querySelectorAll(".chart .sentence");
      sentenceSelects.forEach((select, index) => {
        sentenceRange.forEach((sentence) => {
          const option = document.createElement("option");
          option.value = sentence;
          option.text = sentence;
          select.appendChild(option);
        });
        // when the select element changes, filter the data
        select.addEventListener("change", (event) => {
          const selectedSentence = event.target.value;
          // Filter data based on the selected sentence
          restrictData(selectedSentence, "sentence", index);
          // Find the corresponding stimType
          const stimType = data.find((d) => d.sentence === selectedSentence)?.stimType;
          // Update the message based on stimType
          const messageElement = document.querySelector(`.chart#section${index + 1} .stimType-message`);
          if (stimType === "StimuliGS") {
            messageElement.textContent = "Dieser Satz ist mit dem Genderstern geschrieben.";
          } else if (stimType === "StimuliGM") {
            messageElement.textContent = "Dieser Satz ist im generischen Maskulinum geschrieben.";
          } else {
            messageElement.textContent = ""; // Clear the message if no sentence is selected
            }
          });

      });

      // exposure
      const exposureRange = new Set(data.map((d) => d.exposure));
      const exposureSelects = document.querySelectorAll(".chart .exposure");
      exposureSelects.forEach((select, index) => {
        exposureRange.forEach((exposure) => {
          const option = document.createElement("option");
          option.value = exposure;
          option.text = exposure;
          select.appendChild(option);
        });
        // when the select element changes, filter the data
        select.addEventListener("change", (event) =>
          restrictData(event.target.value, "exposure", index)
        );
      });

      // gender
      const genderRange = new Set(data.map((d) => d.gender));
      const genderSelects = document.querySelectorAll(".chart .gender"); //".chart .gender" != ".chart.gender" != ".chart,.gender"
      genderSelects.forEach((select, index) => {
        genderRange.forEach((gender) => {
          const option = document.createElement("option");
          option.value = gender;
          option.text = gender;
          select.appendChild(option);
        });
        // when the select element changes, filter the data
        select.addEventListener("change", (event) =>
          restrictData(event.target.value, "gender", index)
        );
      });

      // bildung
      const bildungRange = new Set(data.map((d) => d.bildung));
      const bildungSelect = document.querySelectorAll(".chart .bildung");
      bildungSelect.forEach((select, i) => {
        bildungRange.forEach((bildung) => {
          const option = document.createElement("option");
          option.value = bildung;
          option.text = bildung;
          select.appendChild(option);
        });
        // when the select element changes, filter the data
        select.addEventListener("change", (event) =>
          restrictData(event.target.value, "bildung", i)
        );
      });

      // age
      const ageGroupsRange = new Set(data.map((d) => d.ageGroups));
      const ageGroupsSelect = document.querySelectorAll(".chart .ageGroups");
      ageGroupsSelect.forEach((select, i) => {
        ageGroupsRange.forEach((ageGroups) => {
          const option = document.createElement("option");
          option.value = ageGroups;
          option.text = ageGroups;
          select.appendChild(option);
        });
        // when the select element changes, filter the data
        select.addEventListener("change", (event) =>
          restrictData(event.target.value, "ageGroups", i)
        );
      });      
      const buttons = document.querySelectorAll(".chart .button");
      buttons.forEach((button, index) => {
        button.addEventListener("click", () => generateVis(index));
      });
    </script>
    <style>
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>SPR Visualisierung - Experiment</h1>

    <p>Dies ist ein Introtext. Ich ver채ndere das jetzt ein wenig um zu sehen, ob mit dem commit jetzt effekitv alles funktioniert. </p>
    <section class="chart" id="section1">
      <form>
        <label>
          Satz:
          <select class="sentence" name="sentence">
            <option value="">Alle</option>
          </select>
          <p class="stimType-message"></p>
        </label>
        <label>
          Aussetzung:
          <select class="exposure" name="exposure">
            <option value="">Alle</option>
          </select>
        </label>
        <label>
          Geschlecht:
          <select class="gender" name="gender">
            <option value="">Alle</option>
          </select>
        </label>
        <label for="bildung">
          Bildungsgrad:
          <select class="bildung" name="bildung">
            <option value="">Alle</option>
          </select>
        </label>
        <label for="ageGroups">
          Alter:
          <select class="ageGroups" name="ageGroups">
            <option value="">Alle</option>
          </select>
        </label>
      </form>
      <p class="dataset-size">Es wurden alle Datens채tze selektiert.</p>
      <button class="button">Visualisierung generieren</button>
    </section>
    <section class="vis hidden" id="vis1">Visualisierung 1</section>
    
    <section class="chart" id="section2">
      <form>
        <label>
          Satz:
          <select class="sentence" name="sentence">
            <option value="">Alle</option>
          </select>
          <p class="stimType-message"></p>
        </label>
        <label>
          Aussetzung:
          <select class="exposure" name="exposure">
            <option value="">Alle</option>
          </select>
        </label>
        <label>
          Geschlecht:
          <select class="gender" name="gender">
            <option value="">Alle</option>
          </select>
        </label>
        <label for="bildung">
          Bildungsgrad:
          <select class="bildung" name="bildung">
            <option value="">Alle</option>
          </select>
        </label>
        <label for="ageGroups">
          Alter:
          <select class="ageGroups" name="ageGroups">
            <option value="">Alle</option>
          </select>
        </label>
      </form>
      <p class="dataset-size">Es wurden alle Datens채tze selektiert.</p>
      <button class="button">Visualisierung generieren</button>
    </section>
    <section class="vis hidden" id="vis2">Visualisierung 2</section>
  </body>
</html>
