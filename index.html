<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SPR Visualisierung</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script type="module"> //script in 
      // fetching the csv file and making it accessible as an array of objects
      const data = await d3.csv("DHdataVis.csv"); // fetches the CSV file and converts it into an array of objects 
      console.log("hello world");
      console.log(data);
      let filteredData = [data, data]; // stores subsets of the data (based on dropdown selection)
      let filters = [{}, {}];

      /**
       * Function to restrict the data based on the selected values.
       * @param {Event} e Input event. we currently only use the value of the Select element.
       * @param {string} key The key of the filter object. may be any key of the data object.
       * @param {number} dataIndex The index of the data array to filter.
       */
      function restrictData(value, key, dataIndex) { // filters the data when users change the dropdown selection
        if (value) {
          filters[dataIndex][key] = value;
        } else {
          delete filters[dataIndex][key];
        }
        filteredData[dataIndex] = data.filter((d) =>
          Object.entries(filters[dataIndex]).every(
            ([key, value]) => d[key] === value
          )
        );
        document.querySelector(
          `.chart#section${dataIndex + 1} .dataset-size`
        ).textContent = `Es wurden ${filteredData[dataIndex].length} Datensätze selektiert`; // updates the message below the dropdown telling the number of selected datasets
        console.log(filteredData[dataIndex]);
      }

      function generateVis(index, words, normalizedTimes) { //creates visualisation of selected sentence
        console.log("Generating visualization for section", index + 1);

        // Get the visualization container for the current section
        const visContainer = document.querySelector(`.vis#vis${index + 1}`);
        visContainer.classList.remove("hidden"); // Unhide the visualization section - as part of the generateVis function 
        visContainer.innerHTML = ""; // Clear any existing content

        // Dynamically create and style words
        words.forEach((word, wordIndex) => { //creates visualisation of selected sentence - splits it in individual words
          const span = document.createElement("span");
          span.textContent = word;
          span.style.fontStretch = `${normalizedTimes[wordIndex]}%`; // Stretch font based on reaction time
          span.style.marginRight = "10px"; // Add some spacing between words
          visContainer.appendChild(span);
        });
      }

      // creating the select elements for the filters
      // sentence
      const sentenceRange = new Set(data.map((d) => d.sentence));
      const sentenceSelects = document.querySelectorAll(".chart .sentence");
      sentenceSelects.forEach((select, index) => {
        sentenceRange.forEach((sentence) => {
          const option = document.createElement("option");
          option.value = sentence;
          option.text = sentence;
          select.appendChild(option);
        });

        // when the select element changes, filter the data and update the message
        select.addEventListener("change", (event) => {
          const selectedSentence = event.target.value;

          // Filter data based on the selected sentence
          restrictData(selectedSentence, "sentence", index);

          // Find the corresponding stimType
          const stimType = data.find((d) => d.sentence === selectedSentence)?.stimType;

          // Update the message based on stimType
          const messageElement = document.querySelector(
            `.chart#section${index + 1} .stimType-message`
          );
          if (stimType === "StimuliGS") {
            messageElement.textContent = "Dieser Satz ist mit dem Genderstern geschrieben.";
          } else if (stimType === "StimuliGM") {
            messageElement.textContent = "Dieser Satz ist im generischen Maskulinum geschrieben.";
          } else {
            messageElement.textContent = ""; // Clear the message if no sentence is selected
          }
        });
      });

      // exposure
      const exposureRange = new Set(data.map((d) => d.exposure));
      const exposureSelects = document.querySelectorAll(".chart .exposure");
      exposureSelects.forEach((select, index) => {
        exposureRange.forEach((exposure) => {
          const option = document.createElement("option");
          option.value = exposure;
          option.text = exposure;
          select.appendChild(option);
        });
        // when the select element changes, filter the data
        select.addEventListener("change", (event) => // when a dropdown selection changes, the data is filtered and message updated
          restrictData(event.target.value, "exposure", index)
        );
      });

      // gender
      const genderRange = new Set(data.map((d) => d.gender));
      const genderSelects = document.querySelectorAll(".chart .gender");
      genderSelects.forEach((select, index) => {
        genderRange.forEach((gender) => {
          const option = document.createElement("option");
          option.value = gender;
          option.text = gender;
          select.appendChild(option);
        });
        // when the select element changes, filter the data
        select.addEventListener("change", (event) =>
          restrictData(event.target.value, "gender", index)
        );
      });

      // bildung
      const bildungRange = new Set(data.map((d) => d.bildung));
      const bildungSelect = document.querySelectorAll(".chart .bildung");
      bildungSelect.forEach((select, i) => {
        bildungRange.forEach((bildung) => {
          const option = document.createElement("option");
          option.value = bildung;
          option.text = bildung;
          select.appendChild(option);
        });
        // when the select element changes, filter the data
        select.addEventListener("change", (event) =>
          restrictData(event.target.value, "bildung", i)
        );
      });

      // age     
      const ageGroupsRange = new Set(data.map((d) => d.ageGroups));
      const ageGroupsSelect = document.querySelectorAll(".chart .ageGroups");
      ageGroupsSelect.forEach((select, i) => {
        ageGroupsRange.forEach((ageGroups) => {
          const option = document.createElement("option");
          option.value = ageGroups;
          option.text = ageGroups;
          select.appendChild(option);
        });
        // when the select element changes, filter the data
        select.addEventListener("change", (event) =>
          restrictData(event.target.value, "ageGroups", i)
        );
      });

      const buttons = document.querySelectorAll(".chart .button");
      buttons.forEach((button, index) => {
        button.addEventListener("click", () => {
          // Get the selected sentence
          const sentenceSelect = document.querySelector(
            `.chart#section${index + 1} .sentence`
          );
          const selectedSentence = sentenceSelect.value;

          if (!selectedSentence) {
            alert("Bitte wählen Sie einen Satz aus!"); // Alert if no sentence is selected
            return;
          }

          // Split the sentence into words
          const words = selectedSentence.split(" ");

          // Calculate mean reaction times for each word
          const meanReactionTimes = words.map((_, wordIndex) => {
            const key = `word${wordIndex + 1}`; // word1, word2, ..., word10
            const times = filteredData[index].map((d) => +d[key]); // Get reaction times
            return times.reduce((sum, t) => sum + t, 0) / times.length; // Calculate mean
          });

          // Normalize reaction times to a range suitable for font-stretch
          const normalize = (
            value,
            min = 100,
            max = 3000,
            newMin = 50,
            newMax = 200
          ) => {
            return (
              ((value - min) * (newMax - newMin)) / (max - min) + newMin
            );
          };

          const normalizedTimes = meanReactionTimes.map((time) =>
            Math.min(Math.max(normalize(time, 100, 3000, 50, 200), 50), 200) // Clamp values between 50% and 200%
          );

          // Generate the visualization
          generateVis(index, words, normalizedTimes);
        });
      });
    </script>
    <style> /* style, working on aesthetics and/or controlling elements (e.g. hiding) with CSS */
      .hidden { /* hides the element, visualisation as long as the visualisation is not generated (through button press) */
        display: none;
      }
      .vis { /* vis styles the visualisation, feel free to add elements here */
        margin-top: 20px; /* Space above the visualization */
        margin-bottom: 40px; /* Space below the visualization */
      }

    </style>
  </head>

  <body>
    <h1>SPR Visualisierung - Experiment</h1>

    <p>
      Dies ist eine Arbeit die im Herbstsemester 2024 im Rahmen von meiner Abschlussarbeit von meinem Minor in Digital Humanities an der Universität Bern gemacht wurde. Es ist eine <b>Visualisierung</b> von <b>Reaktionszeitdaten</b> von einem <b>Self-Paced Reading Experiment</b>. Die Daten stammen von meiner <b>Masterarbeit</b>.
      <h2>Worum geht es in der Masterarbeit?</h2> Antwort
      <h2>Was ist ein Self-Paced Reading Experiment?</h2> Text. Ein Beispiel findest du <a href="https://www.intro2psycholing.net/resources/experiments/selfpaced.php" target="_blank" rel="noopener noreferrer">hier</a>.
      <h2>Was sind Reaktionszeitdaten?</h2> Antwort
      <h2>Warum ist das wichtig?</h2> Antwort
      <h2>Warum eine Visualisierung?</h2> Antwort
      <h2>Wie funktioniert die Visualisierung?</h2> Antwort. Verbunden mit einer CSV datei. Auf GitHub. Blablabla. Damit kannst du jetzt gleich loslegen: scrolle runter zu den Visualisierungen. 
    </p>
    <p>

      <hr style="margin: 40px 0; border: 1px solid #0f0f0f;" />

      <h1>Visualisierungen</h1> Unten sind zwei Visualisierungsgeneratoren. Somit kannst du mit den Daten experimentieren. Probiere es am besten selbst mal aus! 
    </p>
    <section class="chart" id="section1">
      <form>
        <label>
          Satz:
          <select class="sentence" name="sentence">
            <option value="">Alle</option>
          </select>
          <p class="stimType-message"></p>
        </label>
        <label>
          Exposure:
          <select class="exposure" name="exposure">
            <option value="">Alle</option>
          </select>
        </label>
        <label>
          Geschlecht:
          <select class="gender" name="gender">
            <option value="">Alle</option>
          </select>
        </label>
        <label for="bildung">
          Bildungsgrad:
          <select class="bildung" name="bildung">
            <option value="">Alle</option>
          </select>
        </label>
        <label for="ageGroups">
          Alter:
          <select class="ageGroups" name="ageGroups">
            <option value="">Alle</option>
          </select>
        </label>
      </form>
      <p class="dataset-size">Es wurden alle Datensätze selektiert.</p>
      <button class="button">Visualisierung generieren</button>
    </section>
    <section class="vis hidden" id="vis1">Visualisierung 1</section> <!-- contains two different class; vis and hidden --> 

    <hr style="margin: 40px 0; border: 1px solid #ccc;" />

    <section class="chart" id="section2">
      <form>
        <label>
          Satz:
          <select class="sentence" name="sentence">
            <option value="">Alle</option>
          </select>
          <p class="stimType-message"></p>
        </label>
        <label>
          Exposure:
          <select class="exposure" name="exposure">
            <option value="">Alle</option>
          </select>
        </label>
        <label>
          Geschlecht:
          <select class="gender" name="gender">
            <option value="">Alle</option>
          </select>
        </label>
        <label for="bildung">
          Bildungsgrad:
          <select class="bildung" name="bildung">
            <option value="">Alle</option>
          </select>
        </label>
        <label for="ageGroups">
          Alter:
          <select class="ageGroups" name="ageGroups">
            <option value="">Alle</option>
          </select>
        </label>
      </form>
      <p class="dataset-size">Es wurden alle Datensätze selektiert.</p>
      <button class="button">Visualisierung generieren</button>
    </section>
    <section class="vis hidden" id="vis2">Visualisierung 2</section>
  </body>
</html>